# TIMELOOP SOLUTION
# can a nesting .py file for our control circuit code
# issues: 
# 1) waits for the set interval to run the program for the first time
# --> resolved by calling for the lampOn() before any looping starts, nt crucial for fans
# 2) MIGHT NOT WORK ON RASPBERRY PI --> MULTITHREADING IS WEIRD
# 3) not yet figured out how to make it compatible with website



import time
from timeloop import Timeloop

from datetime import datetime, timedelta

# to install timeloop on windows run in control terminal
# py -m pip install git+https://github.com/sankalpjonn/timeloop.git

# Linux/Raspberry Pi:
# python3 pip install git+https://github.com/sankalpjonn/timeloop.git


tl = Timeloop()
# lampCount corresponds to three different phases:
# case 0: lamp switches on for 8 hours
# case 1: lamp stays on for another 8 hours
# case 2: lamp turns off
# allows to only check on lamp every eight hours

lampCount = 0

def lampOn():
    print('lmpOn')

def lampOff():
    print('lmpOff')

def fanOn():
    print('fanOn')

def fanOff():
    print('fanOff')


# lamp must be 16 hours(seconds in testing phase) on, 8 hours/seconds off
@tl.job(interval=timedelta(seconds=8))
def lamp():
    global lampCount

    # if it's the first phase, lamp turns on for the next 8 hours
    if lampCount == 0:
        print('turning lamp on')
        lampOn()
        lampCount += 1
    elif lampCount == 1:
        print("lamp should stay on for 8 more hours")
        lampCount += 1
        pass
    else:
        print('turning lamp off')
        lampCount = 0
        lampOff()





# fan must be on for 10 seconds, off for 10 minutes
@tl.job(interval=timedelta(minutes=1))
def fans():
    print('executing fan function')
    fanOn()
    time.sleep(1)
    fanOff()

# how to handle everything else?
# get interruption from the website
# make interruption time very long?
# or every couple seconds check for new input fromthe website and adjust/initiate irrigation accordingly?
@tl.job(interval = timedelta(minutes=10))
def irrigation():
    print('still figuring it out')




def main():
    global lampCount
    # block=True handles graceful shutdown of the threads
    lampOn()
    lampCount = 2 # since timeloop will wait for the entire interval (8 hours for lamp) to start with the looping 
    tl.start(block=True)
